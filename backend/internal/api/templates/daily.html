{{define "content"}}
<div class="container">
  <div class="hero">
    <h1>Your Daily Read</h1>
    <p>{{.Date}} â€” {{.Total}} articles curated for you</p>
  </div>
  
  <div class="filters">
    <div class="search-box">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="M21 21l-4.35-4.35"/>
      </svg>
      <input type="text" id="search" placeholder="Search articles..." oninput="filterArticles()">
    </div>
    {{if .Tags}}
    <div class="tags-section">
      <button class="tags-toggle" onclick="toggleTags()" id="tagsToggle">
        <span>Topics</span>
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="tagsToggleIcon">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
      <div class="topic-chips" id="topicChips" style="display: none;">
        <button class="chip active" onclick="filterByTag('')">All</button>
        {{range .Tags}}
        <button class="chip" onclick="filterByTag('{{.Name}}')">{{.Name}} <span class="chip-count">{{.Count}}</span></button>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>
  
  {{if .Articles}}
  <div class="articles" id="articles">
    {{range .Articles}}
    <article class="article-card{{if .IsRead}} read{{end}}" data-id="{{.ID}}" data-title="{{.Title}}" data-summary="{{.Summary}}" data-tags="{{range .Tags}}{{.}} {{end}}">
      <h2><a href="/read/{{.ID}}">{{.Title}}</a></h2>
      {{if .Summary}}
      <p class="summary">{{.Summary}}</p>
      {{end}}
      <div class="article-meta">
        <span class="source">{{if .FeedName}}{{.FeedName}}{{else}}Unknown{{end}}</span>
        <span class="reading-time">{{.ReadingTime}} min read</span>
        {{if .QualityRank}}
        <span class="score{{if ge .QualityRank 80}} high{{else if ge .QualityRank 60}} mid{{end}}">{{.QualityRank}}</span>
        {{end}}
      </div>
      {{if .Tags}}
      <div class="tags">
        {{range .Tags}}
        <span class="tag" onclick="filterByTag('{{.}}'); event.stopPropagation();">{{.}}</span>
        {{end}}
      </div>
      {{end}}
      <div class="article-actions">
        <button class="action-btn" onclick="markRead({{.ID}}); event.stopPropagation();" title="Mark as done">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6L9 17l-5-5"/>
          </svg>
          Done
        </button>
        <button class="action-btn {{if .ReadLater}}saved{{end}}" onclick="toggleSave({{.ID}}); event.stopPropagation();" title="Save forever">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="{{if .ReadLater}}currentColor{{else}}none{{end}}" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
          </svg>
          Save
        </button>
        <button class="action-btn dismiss" onclick="dismissArticle({{.ID}}); event.stopPropagation();" title="Not interested">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </article>
    {{end}}
  </div>
  
  {{if gt .TotalPages 1}}
  <div class="pagination">
    {{if .HasPrev}}
    <a href="/?page={{.PrevPage}}" class="page-btn">&larr; Prev</a>
    {{else}}
    <span class="page-btn disabled">&larr; Prev</span>
    {{end}}
    <span class="page-info">Page {{.Page}} of {{.TotalPages}}</span>
    {{if .HasNext}}
    <a href="/?page={{.NextPage}}" class="page-btn">Next &rarr;</a>
    {{else}}
    <span class="page-btn disabled">Next &rarr;</span>
    {{end}}
  </div>
  {{end}}
  
  <div class="empty-state" id="no-results" style="display: none;">
    <p>No articles match your search.</p>
  </div>
  {{else}}
  <div class="empty-state">
    <p>No scored articles yet. The LLM is processing your feeds...</p>
    <a href="/feeds" class="btn btn-primary">Manage Feeds</a>
  </div>
  {{end}}
</div>

<script>
var currentTag = '';
var currentSearch = '';
var tagsExpanded = false;

function toggleTags() {
  tagsExpanded = !tagsExpanded;
  var chips = document.getElementById('topicChips');
  var icon = document.getElementById('tagsToggleIcon');
  if (tagsExpanded) {
    chips.style.display = 'flex';
    icon.style.transform = 'rotate(180deg)';
  } else {
    chips.style.display = 'none';
    icon.style.transform = 'rotate(0deg)';
  }
}

function filterArticles() {
  currentSearch = document.getElementById('search').value.toLowerCase();
  applyFilters();
}

function filterByTag(tag) {
  currentTag = tag;
  document.querySelectorAll('.chip').forEach(function(c) {
    c.classList.remove('active');
  });
  if (tag === '') {
    document.querySelector('.chip').classList.add('active');
  } else {
    document.querySelectorAll('.chip').forEach(function(c) {
      if (c.textContent.trim().startsWith(tag)) c.classList.add('active');
    });
  }
  applyFilters();
}

function applyFilters() {
  var articles = document.querySelectorAll('.article-card');
  var visibleCount = 0;
  
  articles.forEach(function(article) {
    var title = (article.dataset.title || '').toLowerCase();
    var summary = (article.dataset.summary || '').toLowerCase();
    var tags = (article.dataset.tags || '').toLowerCase();
    
    var matchesSearch = !currentSearch || 
      title.includes(currentSearch) || 
      summary.includes(currentSearch);
    var matchesTag = !currentTag || tags.includes(currentTag.toLowerCase());
    
    if (matchesSearch && matchesTag) {
      article.style.display = '';
      visibleCount++;
    } else {
      article.style.display = 'none';
    }
  });
  
  document.getElementById('no-results').style.display = visibleCount === 0 ? '' : 'none';
}

function markRead(id) {
  fetch('/api/articles/' + id + '/read', { method: 'POST' })
    .then(function(res) {
      if (res.ok) {
        var el = document.querySelector('[data-id="' + id + '"]');
        if (el) {
          el.style.opacity = '0.5';
          setTimeout(function() { el.remove(); }, 300);
        }
      }
    });
}

function toggleSave(id) {
  fetch('/api/articles/' + id + '/save', { method: 'POST' })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      var btn = document.querySelector('[data-id="' + id + '"] .action-btn:nth-child(2)');
      if (btn) {
        if (data.data.saved) {
          btn.classList.add('saved');
          btn.querySelector('svg').setAttribute('fill', 'currentColor');
        } else {
          btn.classList.remove('saved');
          btn.querySelector('svg').setAttribute('fill', 'none');
        }
      }
    });
}

function dismissArticle(id) {
  if (!confirm('Remove this article permanently?')) return;
  fetch('/api/articles/' + id, { method: 'DELETE' })
    .then(function(res) {
      if (res.ok) {
        var el = document.querySelector('[data-id="' + id + '"]');
        if (el) {
          el.style.opacity = '0';
          el.style.transform = 'translateX(-20px)';
          setTimeout(function() { el.remove(); }, 200);
        }
      }
    });
}
</script>
{{end}}
